# Phase 7: Google Docs Integration - Implementation Plan

**Date**: 2025-11-13
**Phase**: 7 of 8
**Estimated effort**: 3-5 days
**Can be done in Claude Code Web**: 85%

---

## Goal

Add selective Google Docs pairing to enable bidirectional sync between local markdown files and Google Docs.

**Key difference from Phase 3 (Notion Mirror Mode)**:
- Phase 3: Mirror entire directory structure automatically
- Phase 7: Manual pairing of individual files (pair mode)

---

## Prerequisites

✅ **Available**:
- Google Workspace MCP server with access to:
  - `mcp__google-workspace__search_docs` - Find Google Docs
  - `mcp__google-workspace__get_doc_content` - Read Doc content
  - `mcp__google-workspace__create_doc` - Create new Docs
  - `mcp__google-workspace__modify_doc_text` - Update Doc content
  - `mcp__google-workspace__list_docs_in_folder` - Browse Docs
  - `mcp__google-workspace__find_and_replace_doc` - Text operations

⏳ **To verify**:
- Google OAuth authentication status
- Document format conversion requirements
- Markdown ↔ Google Docs mapping strategy

---

## Architecture Overview

```
┌──────────────────────────────────────────────────────────────────┐
│                     CLI Layer (portals/cli)                      │
│  Commands: pair, unpair, list, sync (enhanced)                   │
└───────────────────────────┬──────────────────────────────────────┘
                            │
┌───────────────────────────▼──────────────────────────────────────┐
│                   Pair Mode Service                              │
│  - Create/remove pairs                                           │
│  - Manage pair metadata                                          │
│  - Coordinate sync operations                                    │
└───────────────────────────┬──────────────────────────────────────┘
                            │
           ┌────────────────┼────────────────┐
           │                                 │
┌──────────▼──────────┐           ┌─────────▼──────────┐
│  LocalFileAdapter   │           │  GoogleDocsAdapter │
│  (existing)         │           │  (NEW)             │
│                     │           │                    │
│  - Read markdown    │◄─────────►│  - Read Docs       │
│  - Write markdown   │   Sync    │  - Write Docs      │
│  - Hash content     │  Engine   │  - Convert formats │
└─────────────────────┘           └────────────────────┘
                                            │
                                  ┌─────────▼──────────┐
                                  │  Google Docs MCP   │
                                  │  - API calls       │
                                  │  - OAuth auth      │
                                  └────────────────────┘
```

---

## Implementation Steps

### Step 1: Google Docs Adapter (2-3 days, 90% Web)

**Location**: `portals/adapters/gdocs/`

#### 1.1 Create Adapter Base Structure

**File**: `portals/adapters/gdocs/adapter.py`

```python
class GoogleDocsAdapter(DocumentAdapter):
    """Adapter for Google Docs using MCP server."""

    def __init__(self, user_email: str):
        self.user_email = user_email
        self.mcp_client = MCPClient()

    async def read(self, uri: str) -> Document:
        """Read Google Doc and convert to markdown."""
        pass

    async def write(self, uri: str, doc: Document) -> None:
        """Convert markdown to Google Doc format and update."""
        pass

    async def get_metadata(self, uri: str) -> RemoteMetadata:
        """Get Doc metadata (last modified, hash)."""
        pass

    async def exists(self, uri: str) -> bool:
        """Check if Doc exists."""
        pass

    async def create(self, uri: str, doc: Document, parent_id: str | None) -> str:
        """Create new Google Doc."""
        pass

    def parse_uri(self, uri: str) -> PlatformURI:
        """Parse Google Docs URI (gdoc://doc-id or doc-id)."""
        pass
```

**URI Format**: `gdoc://document-id` or just `document-id`

#### 1.2 Format Conversion (Critical)

**File**: `portals/adapters/gdocs/converter.py`

Google Docs uses structured elements, markdown uses plain text with syntax.

**Conversion Strategy**:

```python
class GoogleDocsConverter:
    """Convert between Markdown and Google Docs format."""

    def markdown_to_gdocs(self, markdown: str) -> list[dict]:
        """Convert markdown to Google Docs structure.

        Markdown -> Google Docs mapping:
        # Heading 1 -> Heading 1
        ## Heading 2 -> Heading 2
        **bold** -> Bold text
        *italic* -> Italic text
        - list -> Bullet list
        1. list -> Numbered list
        [link](url) -> Link
        `code` -> Code (inline)
        ```code``` -> Code block
        """
        pass

    def gdocs_to_markdown(self, doc_structure: dict) -> str:
        """Convert Google Docs structure to markdown.

        Read from MCP get_doc_content response.
        """
        pass
```

**Key Challenge**: Google Docs is WYSIWYG, markdown is text. We need to:
1. Preserve basic formatting (headings, bold, italic, lists)
2. Accept that some formatting will be lost (colors, fonts, etc.)
3. Store original Doc ID in markdown frontmatter

#### 1.3 MCP Integration

**File**: `portals/adapters/gdocs/mcp_client.py`

```python
class MCPClient:
    """Wrapper for Google Workspace MCP tools."""

    def __init__(self, user_email: str):
        self.user_email = user_email

    async def get_doc(self, doc_id: str) -> dict:
        """Get Doc content using MCP."""
        # Call mcp__google-workspace__get_doc_content
        pass

    async def update_doc(self, doc_id: str, content: str) -> None:
        """Update Doc using MCP."""
        # Call mcp__google-workspace__modify_doc_text
        pass

    async def create_doc(self, title: str, content: str) -> str:
        """Create new Doc using MCP."""
        # Call mcp__google-workspace__create_doc
        pass

    async def search_docs(self, query: str) -> list[dict]:
        """Search for Docs using MCP."""
        # Call mcp__google-workspace__search_docs
        pass
```

**Tests** (can write in Web with mocks):
- `tests/unit/test_gdocs_adapter.py` - 15-20 tests
- `tests/unit/test_gdocs_converter.py` - 20-25 tests
- `tests/integration/test_gdocs_mcp.py` - Real MCP calls (Desktop only)

---

### Step 2: Pair Mode Service (1-2 days, 80% Web)

**Location**: `portals/services/pair_service.py`

```python
class PairService:
    """Service for managing document pairs (manual pairing)."""

    def __init__(self, base_path: Path):
        self.base_path = base_path
        self.metadata_store = MetadataStore(base_path)

    async def create_pair(
        self,
        local_path: str,
        remote_uri: str,
        platform: str,  # "notion" or "gdocs"
    ) -> SyncPair:
        """Create a new document pair."""
        pass

    async def remove_pair(self, local_path: str) -> None:
        """Remove a document pair."""
        pass

    async def list_pairs(self) -> list[SyncPair]:
        """List all document pairs."""
        pass

    async def get_pair(self, local_path: str) -> SyncPair | None:
        """Get pair for local file."""
        pass

    async def sync_pair(
        self,
        local_path: str,
        force_direction: str | None = None,
    ) -> SyncResult:
        """Sync a specific pair."""
        pass
```

**Metadata Storage Enhancement**:

Current metadata.json:
```json
{
  "config": {
    "mode": "notion-mirror",
    "root_page_id": "..."
  },
  "pairs": {
    "uuid": {
      "local_path": "file.md",
      "remote_uri": "notion://...",
      "remote_platform": "notion"
    }
  }
}
```

Enhanced for pair mode:
```json
{
  "config": {
    "mode": "pair",  // New mode
    "platforms": ["notion", "gdocs"]  // Track active platforms
  },
  "pairs": {
    "uuid-1": {
      "local_path": "report.md",
      "remote_uri": "gdoc://abc123",
      "remote_platform": "gdocs",
      "created_at": "...",
      "state": {...}
    },
    "uuid-2": {
      "local_path": "notes.md",
      "remote_uri": "notion://xyz789",
      "remote_platform": "notion",
      "created_at": "...",
      "state": {...}
    }
  }
}
```

---

### Step 3: CLI Commands (1 day, 95% Web)

**Location**: `portals/cli/main.py`

#### New Commands:

```python
@cli.command()
@click.argument("local_path")
@click.argument("remote_uri")
@click.option("--platform", type=click.Choice(["notion", "gdocs"]), required=True)
def pair(local_path: str, remote_uri: str, platform: str):
    """Create a pair between local file and remote document.

    Examples:
      docsync pair report.md gdoc://abc123 --platform=gdocs
      docsync pair notes.md notion://xyz789 --platform=notion
    """
    pass

@cli.command()
@click.argument("local_path")
def unpair(local_path: str):
    """Remove pair for local file.

    Example:
      docsync unpair report.md
    """
    pass

@cli.command()
def list():
    """List all document pairs.

    Shows:
    - Local file path
    - Remote URI
    - Platform (notion/gdocs)
    - Last sync time
    - Conflict status
    """
    pass
```

#### Enhanced Commands:

```python
# Update existing commands to support pair mode:

@cli.command()
@click.argument("path", required=False)
# ... existing options ...
def sync(path, ...):
    """Sync documents (works in both mirror and pair modes).

    Mirror mode: Syncs all files in directory structure
    Pair mode: Syncs only paired documents
    """
    # Check metadata mode, dispatch accordingly
    pass

@cli.command()
# ... options ...
def watch(...):
    """Watch for changes (works in both mirror and pair modes).

    Mirror mode: Watches entire directory
    Pair mode: Watches only paired files
    """
    # Check metadata mode, adapt file watching
    pass
```

---

### Step 4: Integration & Testing (1-2 days, 50% Web, 50% Desktop)

#### Unit Tests (Web)
- Adapter tests with mocked MCP calls
- Converter tests with sample data
- Service tests with mocked adapters

#### Integration Tests (Desktop)
- Real Google Docs API calls
- End-to-end pairing workflow
- Bidirectional sync verification
- Conflict detection with Google Docs

#### Test Scenarios:
1. **Create pair**: Link markdown file to Google Doc
2. **Sync local → remote**: Update Google Doc from markdown
3. **Sync remote → local**: Update markdown from Google Doc
4. **Detect conflicts**: Both sides modified
5. **Format preservation**: Headings, lists, bold, italic
6. **Multiple pairs**: Notion + Google Docs pairs coexist
7. **Watch mode**: Detect changes in paired files only

---

## Design Decisions

### 1. Pairing Strategy: Manual vs Auto

**Decision**: Manual pairing (pair mode)

**Rationale**:
- Google Docs doesn't have hierarchical structure like Notion
- Users may want selective syncing
- More flexible - can pair with existing Docs
- Complements Notion mirror mode

### 2. Format Conversion: Lossy vs Lossless

**Decision**: Lossy conversion (preserve basics only)

**What we keep**:
- Headings (H1-H6)
- Bold, italic, underline
- Bullet lists, numbered lists
- Links
- Code blocks

**What we lose**:
- Colors
- Custom fonts
- Images (initially)
- Tables (initially)
- Comments/suggestions

**Rationale**:
- Markdown is plain text format
- Focus on content, not styling
- Can enhance later for images/tables

### 3. URI Format: Custom vs Standard

**Decision**: Custom URI format (`gdoc://doc-id`)

**Rationale**:
- Consistent with Notion URIs (`notion://page-id`)
- Easy to parse and validate
- Can extract Doc ID easily

### 4. Metadata Mode: Separate vs Unified

**Decision**: Unified metadata with mode field

**Rationale**:
- Single `.docsync` directory
- Same CLI commands work for both modes
- Can have mixed pairs (Notion + Google Docs)

---

## Acceptance Criteria

Phase 7 is complete when:

- [ ] GoogleDocsAdapter can read Google Docs
- [ ] GoogleDocsAdapter can write to Google Docs
- [ ] Markdown ↔ Google Docs conversion works (basic formatting)
- [ ] `docsync pair` command creates pairs
- [ ] `docsync unpair` command removes pairs
- [ ] `docsync list` command shows all pairs
- [ ] `docsync sync` works in pair mode
- [ ] `docsync watch` works in pair mode
- [ ] Can have both Notion and Google Docs pairs simultaneously
- [ ] Conflict detection works with Google Docs
- [ ] All tests passing (unit + integration)
- [ ] End-to-end verified with real Google Docs

---

## Risks & Mitigations

### Risk 1: Google Docs API Complexity
**Impact**: High
**Mitigation**: Use MCP server abstraction, focus on basic operations first

### Risk 2: Format Conversion Accuracy
**Impact**: Medium
**Mitigation**: Start with basic formatting, iterate based on testing

### Risk 3: OAuth Authentication Flow
**Impact**: Medium
**Mitigation**: Leverage existing MCP OAuth handling

### Risk 4: Rate Limiting
**Impact**: Low
**Mitigation**: Same strategy as Notion - reasonable polling intervals

---

## Development Strategy

### Day 1-2: Adapter Development (Web)
- Implement GoogleDocsAdapter skeleton
- Implement converter (markdown ↔ Docs)
- Write unit tests with mocks
- Test locally with Desktop for MCP calls

### Day 3: Service Layer (Web)
- Implement PairService
- Update MetadataStore for pair mode
- Write unit tests

### Day 4: CLI Commands (Web + Desktop)
- Implement pair, unpair, list commands
- Update sync and watch for pair mode
- Test with real Google Docs

### Day 5: Integration & Polish (Desktop)
- End-to-end testing
- Bug fixes
- Documentation
- Performance optimization

---

## Success Metrics

**Functionality**:
- Create/remove pairs: < 1 second
- Sync operation: < 5 seconds per Doc
- Format conversion accuracy: > 95% for basic formatting

**Code Quality**:
- Test coverage: > 85%
- All tests passing
- No critical bugs

**User Experience**:
- Clear error messages
- Intuitive CLI commands
- Works alongside existing Notion sync

---

## Next Steps (After This Plan)

1. **Authenticate with Google Workspace MCP** - Verify OAuth works
2. **Test MCP calls** - Try reading a sample Google Doc
3. **Implement GoogleDocsAdapter** - Start with read operations
4. **Implement converter** - Basic markdown → Docs
5. **Create PairService** - Metadata management
6. **Add CLI commands** - pair, unpair, list
7. **Integration testing** - End-to-end with real Docs
8. **Documentation** - Update README and docs

---

## Related Documents

- `/01-context/2025-11-11_IMPLEMENTATION_PLAN.md` - Original 8-phase plan
- `/01-context/2025-11-12_REMOTE_VS_LOCAL_DEVELOPMENT.md` - Web vs Desktop strategy
- `PROGRESS.md` - Overall project status

---

**Phase 7 estimated completion**: 3-5 days
**Development environment**: 85% Web, 15% Desktop
**Ready to start**: YES ✅
